name: e2e-testnet-deploy

on:
  workflow_dispatch:
    inputs:
      base_rpc_url:
        description: "Base testnet RPC URL"
        required: true
        default: "https://base-sepolia.drpc.org"
        type: string
      base_chain_id:
        description: "Base testnet chain ID"
        required: true
        default: "84532"
        type: string
      base_operator_fund_wei:
        description: "Prefund amount per operator in wei"
        required: true
        default: "1000000000000000"
        type: string
      bridge_verifier_address:
        description: "SP1 verifier gateway address"
        required: true
        type: string
      bridge_deposit_image_id:
        description: "Deposit image ID (bytes32 hex)"
        required: true
        type: string
      bridge_withdraw_image_id:
        description: "Withdraw image ID (bytes32 hex)"
        required: true
        type: string
      bridge_run_timeout:
        description: "bridge-e2e timeout duration (e.g. 90m)"
        required: true
        default: "90m"
        type: string
      sp1_rpc_url:
        description: "SP1 submission RPC URL"
        required: true
        default: "https://mainnet.base.org"
        type: string
      sp1_deposit_program_url:
        description: "Deposit guest program URL for SP1"
        required: true
        type: string
      sp1_withdraw_program_url:
        description: "Withdraw guest program URL for SP1"
        required: true
        type: string
      sp1_input_s3_bucket:
        description: "S3 bucket for oversized SP1 guest inputs"
        required: true
        type: string
      sp1_deposit_owallet_ivk_hex:
        description: "64-byte oWallet IVK hex for deposit witness extraction"
        required: true
        type: string
      sp1_withdraw_owallet_ovk_hex:
        description: "32-byte oWallet OVK hex for withdraw witness extraction"
        required: true
        type: string
      sp1_witness_juno_scan_url:
        description: "juno-scan URL used for run-generated witness extraction"
        required: true
        type: string
      sp1_witness_juno_rpc_url:
        description: "junocashd RPC URL used for run-generated witness extraction"
        required: true
        type: string
      sp1_max_price_per_pgu:
        description: "SP1 max price per PGU in wei"
        required: true
        default: "50000000000000"
        type: string
      sp1_min_auction_period:
        description: "SP1 minimum auction period in seconds"
        required: true
        default: "85"
        type: string
      sp1_auction_timeout:
        description: "SP1 auction timeout duration (seconds with s suffix)"
        required: true
        default: "625s"
        type: string
      sp1_request_timeout:
        description: "SP1 request timeout duration (seconds with s suffix)"
        required: true
        default: "1500s"
        type: string

permissions:
  contents: read

jobs:
  run-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install SP1 Adapter Build Deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y protobuf-compiler clang libclang-dev pkg-config libssl-dev

      - name: Build SP1 Prover Adapter
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --manifest-path zk/sp1_prover_adapter/cli/Cargo.toml
          mkdir -p "$HOME/.local/bin"
          install -m 0755 zk/target/release/sp1-prover-adapter "$HOME/.local/bin/sp1-prover-adapter"
          ln -sf "$HOME/.local/bin/sp1-prover-adapter" "$HOME/.local/bin/sp1"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.BASE_FUNDER_PRIVATE_KEY_HEX }}" ]]; then
            echo "BASE_FUNDER_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}" ]]; then
            echo "JUNO_FUNDER_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.SP1_REQUESTOR_PRIVATE_KEY_HEX }}" ]]; then
            echo "SP1_REQUESTOR_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.JUNO_RPC_USER }}" ]]; then
            echo "JUNO_RPC_USER secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.JUNO_RPC_PASS }}" ]]; then
            echo "JUNO_RPC_PASS secret is required"
            exit 1
          fi

      - name: Prepare funder key file
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci/secrets
          printf '%s\n' "${{ secrets.BASE_FUNDER_PRIVATE_KEY_HEX }}" > .ci/secrets/base-funder.key
          chmod 0600 .ci/secrets/base-funder.key
          printf '%s\n' "${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}" > .ci/secrets/juno-funder.key
          chmod 0600 .ci/secrets/juno-funder.key
          printf '%s\n' "${{ secrets.SP1_REQUESTOR_PRIVATE_KEY_HEX }}" > .ci/secrets/sp1-requestor.key
          chmod 0600 .ci/secrets/sp1-requestor.key

      - name: Preflight SP1 Credit Guardrail
        shell: bash
        run: |
          set -euo pipefail
          requestor_key_hex="$(tr -d '\r\n' < .ci/secrets/sp1-requestor.key)"
          requestor_address="$(cast wallet address --private-key "$requestor_key_hex")"
          export NETWORK_PRIVATE_KEY="$requestor_key_hex"
          export SP1_NETWORK_RPC_URL="${{ inputs.sp1_rpc_url }}"
          balance_json="$(printf '{"version":"sp1.balance.request.v1","requestor_address":"%s"}\n' "$requestor_address" | sp1-prover-adapter)"
          balance_wei="$(jq -er '.balance_wei' <<<"$balance_json")"
          [[ "$balance_wei" =~ ^[0-9]+$ ]] || {
            echo "invalid SP1 balance_wei response: $balance_wei"
            exit 1
          }

          max_price_per_pgu="${{ inputs.sp1_max_price_per_pgu }}"
          [[ "$max_price_per_pgu" =~ ^[0-9]+$ ]] || {
            echo "sp1_max_price_per_pgu must be numeric"
            exit 1
          }
          projected_max_cost_wei=$((max_price_per_pgu * 2))
          projected_with_overhead_wei=$(((projected_max_cost_wei * 120 + 99) / 100))
          required_buffer_wei=$((projected_with_overhead_wei * 3))

          if (( balance_wei < required_buffer_wei )); then
            refill_wei=$((required_buffer_wei - balance_wei))
            echo "SP1 requestor balance below required guardrail."
            echo "requestor_address=$requestor_address"
            echo "balance_wei=$balance_wei required_wei=$required_buffer_wei refill_wei=$refill_wei"
            exit 1
          fi

          echo "SP1 credit preflight passed: requestor_address=$requestor_address balance_wei=$balance_wei required_wei=$required_buffer_wei"

      - name: Start Shared Infra (Postgres + Kafka + IPFS)
        shell: bash
        run: |
          set -euo pipefail
          docker rm -f intents-shared-postgres intents-shared-kafka intents-shared-ipfs >/dev/null 2>&1 || true

          docker run -d \
            --name intents-shared-postgres \
            --restart unless-stopped \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=intents_e2e \
            -p 5432:5432 \
            postgres:16-alpine

          docker run -d \
            --name intents-shared-kafka \
            --restart unless-stopped \
            -p 9092:9092 \
            docker.redpanda.com/redpandadata/redpanda:v24.3.7 \
            redpanda start \
              --overprovisioned \
              --smp 1 \
              --memory 1G \
              --reserve-memory 0M \
              --node-id 0 \
              --check=false \
              --kafka-addr PLAINTEXT://0.0.0.0:9092 \
              --advertise-kafka-addr PLAINTEXT://127.0.0.1:9092

          docker run -d \
            --name intents-shared-ipfs \
            --restart unless-stopped \
            -p 5001:5001 \
            ipfs/kubo:v0.32.1 \
            daemon --migrate=true --api /ip4/0.0.0.0/tcp/5001 --routing=dhtclient

          for attempt in $(seq 1 30); do
            if docker exec intents-shared-postgres pg_isready -h 127.0.0.1 -p 5432 -U postgres -d intents_e2e >/dev/null 2>&1; then
              break
            fi
            if [[ "$attempt" -eq 30 ]]; then
              echo "postgres readiness check failed"
              docker logs intents-shared-postgres || true
              exit 1
            fi
            sleep 2
          done

          for attempt in $(seq 1 30); do
            if timeout 2 bash -lc '</dev/tcp/127.0.0.1/9092' >/dev/null 2>&1; then
              break
            fi
            if [[ "$attempt" -eq 30 ]]; then
              echo "kafka readiness check failed"
              docker logs intents-shared-kafka || true
              exit 1
            fi
            sleep 2
          done

          for attempt in $(seq 1 30); do
            if timeout 2 bash -lc '</dev/tcp/127.0.0.1/5001' >/dev/null 2>&1; then
              break
            fi
            if [[ "$attempt" -eq 30 ]]; then
              echo "ipfs readiness check failed"
              docker logs intents-shared-ipfs || true
              exit 1
            fi
            sleep 2
          done

          {
            echo "E2E_SHARED_POSTGRES_DSN=postgresql://postgres:postgres@127.0.0.1:5432/intents_e2e?sslmode=disable"
            echo "E2E_SHARED_KAFKA_BROKERS=127.0.0.1:9092"
            echo "E2E_SHARED_IPFS_API_URL=http://127.0.0.1:5001"
          } >> "$GITHUB_ENV"

      - name: Run Testnet E2E
        shell: bash
        env:
          JUNO_FUNDER_PRIVATE_KEY_HEX: ${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}
          JUNO_RPC_USER: ${{ secrets.JUNO_RPC_USER }}
          JUNO_RPC_PASS: ${{ secrets.JUNO_RPC_PASS }}
          JUNO_SCAN_BEARER_TOKEN: ${{ secrets.JUNO_SCAN_BEARER_TOKEN }}
        run: |
          set -euo pipefail
          E2E_WORKDIR="${RUNNER_TEMP}/testnet-e2e"
          ARGS=(
            run
            --workdir "$E2E_WORKDIR"
            --base-rpc-url "${{ inputs.base_rpc_url }}"
            --base-chain-id "${{ inputs.base_chain_id }}"
            --base-funder-key-file ".ci/secrets/base-funder.key"
            --shared-postgres-dsn "$E2E_SHARED_POSTGRES_DSN"
            --shared-kafka-brokers "$E2E_SHARED_KAFKA_BROKERS"
            --shared-ipfs-api-url "$E2E_SHARED_IPFS_API_URL"
            --base-operator-fund-wei "${{ inputs.base_operator_fund_wei }}"
            --bridge-run-timeout "${{ inputs.bridge_run_timeout }}"
            --bridge-verifier-address "${{ inputs.bridge_verifier_address }}"
            --bridge-deposit-image-id "${{ inputs.bridge_deposit_image_id }}"
            --bridge-withdraw-image-id "${{ inputs.bridge_withdraw_image_id }}"
            --sp1-requestor-key-file ".ci/secrets/sp1-requestor.key"
            --sp1-rpc-url "${{ inputs.sp1_rpc_url }}"
            --sp1-input-mode "guest-witness-v1"
            --sp1-deposit-program-url "${{ inputs.sp1_deposit_program_url }}"
            --sp1-withdraw-program-url "${{ inputs.sp1_withdraw_program_url }}"
            --sp1-input-s3-bucket "${{ inputs.sp1_input_s3_bucket }}"
            --sp1-deposit-owallet-ivk-hex "${{ inputs.sp1_deposit_owallet_ivk_hex }}"
            --sp1-withdraw-owallet-ovk-hex "${{ inputs.sp1_withdraw_owallet_ovk_hex }}"
            --sp1-witness-juno-scan-url "${{ inputs.sp1_witness_juno_scan_url }}"
            --sp1-witness-juno-rpc-url "${{ inputs.sp1_witness_juno_rpc_url }}"
            --sp1-max-price-per-pgu "${{ inputs.sp1_max_price_per_pgu }}"
            --sp1-min-auction-period "${{ inputs.sp1_min_auction_period }}"
            --sp1-auction-timeout "${{ inputs.sp1_auction_timeout }}"
            --sp1-request-timeout "${{ inputs.sp1_request_timeout }}"
            --output "$E2E_WORKDIR/reports/testnet-e2e-summary.json"
            --force
          )
          ./deploy/operators/dkg/e2e/run-testnet-e2e.sh "${ARGS[@]}"

      - name: Upload E2E Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-testnet-deploy
          path: |
            ${{ runner.temp }}/testnet-e2e/reports
