name: e2e-testnet-deploy

on:
  workflow_dispatch:
    inputs:
      base_rpc_url:
        description: "Base testnet RPC URL"
        required: true
        type: string
      base_chain_id:
        description: "Base testnet chain ID"
        required: true
        default: "84532"
        type: string
      base_operator_fund_wei:
        description: "Prefund amount per operator in wei"
        required: true
        default: "1000000000000000"
        type: string
      bridge_verifier_address:
        description: "Optional verifier router address (for real Boundless proof verification)"
        required: false
        default: ""
        type: string
      bridge_deposit_image_id:
        description: "Optional deposit image ID (bytes32 hex)"
        required: false
        default: ""
        type: string
      bridge_withdraw_image_id:
        description: "Optional withdraw image ID (bytes32 hex)"
        required: false
        default: ""
        type: string
      bridge_deposit_seal_hex:
        description: "Optional deposit proof seal hex"
        required: false
        default: ""
        type: string
      bridge_withdraw_seal_hex:
        description: "Optional withdraw proof seal hex"
        required: false
        default: ""
        type: string
      bridge_prepare_only:
        description: "Prepare proof inputs only (skip mint/finalize bridge calls)"
        required: true
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  run-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.BASE_FUNDER_PRIVATE_KEY_HEX }}" ]]; then
            echo "BASE_FUNDER_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}" ]]; then
            echo "JUNO_FUNDER_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi

      - name: Prepare funder key file
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci/secrets
          printf '%s\n' "${{ secrets.BASE_FUNDER_PRIVATE_KEY_HEX }}" > .ci/secrets/base-funder.key
          chmod 0600 .ci/secrets/base-funder.key
          printf '%s\n' "${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}" > .ci/secrets/juno-funder.key
          chmod 0600 .ci/secrets/juno-funder.key

      - name: Prepare optional proof seal files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci/secrets
          if [[ -n "${{ inputs.bridge_deposit_seal_hex }}" ]]; then
            printf '%s\n' "${{ inputs.bridge_deposit_seal_hex }}" > .ci/secrets/bridge-deposit-seal.hex
            chmod 0600 .ci/secrets/bridge-deposit-seal.hex
          fi
          if [[ -n "${{ inputs.bridge_withdraw_seal_hex }}" ]]; then
            printf '%s\n' "${{ inputs.bridge_withdraw_seal_hex }}" > .ci/secrets/bridge-withdraw-seal.hex
            chmod 0600 .ci/secrets/bridge-withdraw-seal.hex
          fi

      - name: Run Testnet E2E
        shell: bash
        env:
          JUNO_FUNDER_PRIVATE_KEY_HEX: ${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}
        run: |
          set -euo pipefail
          E2E_WORKDIR="${RUNNER_TEMP}/testnet-e2e"
          ARGS=(
            run
            --workdir "$E2E_WORKDIR"
            --base-rpc-url "${{ inputs.base_rpc_url }}"
            --base-chain-id "${{ inputs.base_chain_id }}"
            --base-funder-key-file ".ci/secrets/base-funder.key"
            --base-operator-fund-wei "${{ inputs.base_operator_fund_wei }}"
            --output "$E2E_WORKDIR/reports/testnet-e2e-summary.json"
            --force
          )
          if [[ -n "${{ inputs.bridge_verifier_address }}" ]]; then
            ARGS+=(--bridge-verifier-address "${{ inputs.bridge_verifier_address }}")
          fi
          if [[ -n "${{ inputs.bridge_deposit_image_id }}" ]]; then
            ARGS+=(--bridge-deposit-image-id "${{ inputs.bridge_deposit_image_id }}")
          fi
          if [[ -n "${{ inputs.bridge_withdraw_image_id }}" ]]; then
            ARGS+=(--bridge-withdraw-image-id "${{ inputs.bridge_withdraw_image_id }}")
          fi
          if [[ -f ".ci/secrets/bridge-deposit-seal.hex" ]]; then
            ARGS+=(--bridge-deposit-seal-file ".ci/secrets/bridge-deposit-seal.hex")
          fi
          if [[ -f ".ci/secrets/bridge-withdraw-seal.hex" ]]; then
            ARGS+=(--bridge-withdraw-seal-file ".ci/secrets/bridge-withdraw-seal.hex")
          fi
          if [[ "${{ inputs.bridge_prepare_only }}" == "true" ]]; then
            ARGS+=(--bridge-prepare-only)
          fi
          ./deploy/operators/dkg/e2e/run-testnet-e2e.sh "${ARGS[@]}"

      - name: Upload E2E Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-testnet-deploy
          path: |
            ${{ runner.temp }}/testnet-e2e/reports
            ${{ runner.temp }}/testnet-e2e/dkg
