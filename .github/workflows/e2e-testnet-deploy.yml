name: e2e-testnet-deploy

on:
  workflow_dispatch:
    inputs:
      base_rpc_url:
        description: "Base testnet RPC URL"
        required: true
        default: "https://base-sepolia.drpc.org"
        type: string
      base_chain_id:
        description: "Base testnet chain ID"
        required: true
        default: "84532"
        type: string
      base_operator_fund_wei:
        description: "Prefund amount per operator in wei"
        required: true
        default: "1000000000000000"
        type: string
      bridge_verifier_address:
        description: "Verifier router address"
        required: true
        type: string
      bridge_deposit_image_id:
        description: "Deposit image ID (bytes32 hex)"
        required: true
        type: string
      bridge_withdraw_image_id:
        description: "Withdraw image ID (bytes32 hex)"
        required: true
        type: string
      bridge_run_timeout:
        description: "bridge-e2e timeout duration (e.g. 90m)"
        required: true
        default: "90m"
        type: string
      boundless_rpc_url:
        description: "Boundless submission RPC URL"
        required: true
        default: "https://mainnet.base.org"
        type: string
      boundless_deposit_program_url:
        description: "Deposit guest program URL for Boundless"
        required: true
        type: string
      boundless_withdraw_program_url:
        description: "Withdraw guest program URL for Boundless"
        required: true
        type: string
      boundless_input_s3_bucket:
        description: "S3 bucket for oversized Boundless guest inputs"
        required: true
        type: string
      boundless_witness_config_json:
        description: "JSON with guest witness extraction args (ivk/ovk/scan+rpd endpoints/wallet ids/txids/action indexes/withdraw fields)"
        required: true
        type: string
      boundless_min_price_wei:
        description: "Boundless min price in wei"
        required: true
        default: "0"
        type: string
      boundless_max_price_wei:
        description: "Boundless max price in wei"
        required: true
        default: "50000000000000"
        type: string
      boundless_max_price_cap_wei:
        description: "Boundless max price cap in wei used by retry bumps"
        required: true
        default: "250000000000000"
        type: string
      boundless_max_price_bump_multiplier:
        description: "Boundless max price bump multiplier for lock-failure retries"
        required: true
        default: "2"
        type: string
      boundless_max_price_bump_retries:
        description: "Boundless max price bump retries for lock-failure retries"
        required: true
        default: "3"
        type: string
      boundless_lock_stake_wei:
        description: "Boundless lock stake in wei"
        required: true
        default: "20000000000000000000"
        type: string
      boundless_bidding_delay_seconds:
        description: "Boundless bidding delay in seconds"
        required: true
        default: "85"
        type: string
      boundless_ramp_up_period_seconds:
        description: "Boundless ramp-up period in seconds"
        required: true
        default: "170"
        type: string
      boundless_lock_timeout_seconds:
        description: "Boundless lock timeout in seconds"
        required: true
        default: "625"
        type: string
      boundless_timeout_seconds:
        description: "Boundless timeout in seconds"
        required: true
        default: "1500"
        type: string

permissions:
  contents: read

jobs:
  run-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Boundless CLI
        shell: bash
        run: |
          set -euo pipefail
          cargo install boundless-cli --version 1.2.0

      - name: Install RISC Zero Tooling
        shell: bash
        run: |
          set -euo pipefail
          cargo install --locked risc0-r0vm --version 3.0.5

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.BASE_FUNDER_PRIVATE_KEY_HEX }}" ]]; then
            echo "BASE_FUNDER_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}" ]]; then
            echo "JUNO_FUNDER_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.BOUNDLESS_REQUESTOR_PRIVATE_KEY_HEX }}" ]]; then
            echo "BOUNDLESS_REQUESTOR_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.JUNO_RPC_USER }}" ]]; then
            echo "JUNO_RPC_USER secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.JUNO_RPC_PASS }}" ]]; then
            echo "JUNO_RPC_PASS secret is required"
            exit 1
          fi

      - name: Prepare funder key file
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci/secrets
          printf '%s\n' "${{ secrets.BASE_FUNDER_PRIVATE_KEY_HEX }}" > .ci/secrets/base-funder.key
          chmod 0600 .ci/secrets/base-funder.key
          printf '%s\n' "${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}" > .ci/secrets/juno-funder.key
          chmod 0600 .ci/secrets/juno-funder.key
          printf '%s\n' "${{ secrets.BOUNDLESS_REQUESTOR_PRIVATE_KEY_HEX }}" > .ci/secrets/boundless-requestor.key
          chmod 0600 .ci/secrets/boundless-requestor.key

      - name: Run Testnet E2E
        shell: bash
        env:
          JUNO_FUNDER_PRIVATE_KEY_HEX: ${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}
          JUNO_RPC_USER: ${{ secrets.JUNO_RPC_USER }}
          JUNO_RPC_PASS: ${{ secrets.JUNO_RPC_PASS }}
          JUNO_SCAN_BEARER_TOKEN: ${{ secrets.JUNO_SCAN_BEARER_TOKEN }}
        run: |
          set -euo pipefail
          E2E_WORKDIR="${RUNNER_TEMP}/testnet-e2e"
          WITNESS_CFG='${{ inputs.boundless_witness_config_json }}'
          DEPOSIT_OWALLET_IVK_HEX="$(jq -er '.deposit_owallet_ivk_hex' <<<"$WITNESS_CFG")"
          WITHDRAW_OWALLET_OVK_HEX="$(jq -er '.withdraw_owallet_ovk_hex' <<<"$WITNESS_CFG")"
          WITNESS_JUNO_SCAN_URL="$(jq -er '.juno_scan_url' <<<"$WITNESS_CFG")"
          WITNESS_JUNO_RPC_URL="$(jq -er '.juno_rpc_url' <<<"$WITNESS_CFG")"
          DEPOSIT_WALLET_ID="$(jq -er '.deposit_wallet_id' <<<"$WITNESS_CFG")"
          DEPOSIT_TXID="$(jq -er '.deposit_txid' <<<"$WITNESS_CFG")"
          DEPOSIT_ACTION_INDEX="$(jq -er '.deposit_action_index' <<<"$WITNESS_CFG")"
          WITHDRAW_WALLET_ID="$(jq -er '.withdraw_wallet_id' <<<"$WITNESS_CFG")"
          WITHDRAW_TXID="$(jq -er '.withdraw_txid' <<<"$WITNESS_CFG")"
          WITHDRAW_ACTION_INDEX="$(jq -er '.withdraw_action_index' <<<"$WITNESS_CFG")"
          WITHDRAW_WITHDRAWAL_ID_HEX="$(jq -er '.withdraw_withdrawal_id_hex' <<<"$WITNESS_CFG")"
          WITHDRAW_RECIPIENT_RAW_ADDRESS_HEX="$(jq -er '.withdraw_recipient_raw_address_hex' <<<"$WITNESS_CFG")"
          ARGS=(
            run
            --workdir "$E2E_WORKDIR"
            --base-rpc-url "${{ inputs.base_rpc_url }}"
            --base-chain-id "${{ inputs.base_chain_id }}"
            --base-funder-key-file ".ci/secrets/base-funder.key"
            --base-operator-fund-wei "${{ inputs.base_operator_fund_wei }}"
            --bridge-run-timeout "${{ inputs.bridge_run_timeout }}"
            --bridge-verifier-address "${{ inputs.bridge_verifier_address }}"
            --bridge-deposit-image-id "${{ inputs.bridge_deposit_image_id }}"
            --bridge-withdraw-image-id "${{ inputs.bridge_withdraw_image_id }}"
            --boundless-requestor-key-file ".ci/secrets/boundless-requestor.key"
            --boundless-rpc-url "${{ inputs.boundless_rpc_url }}"
            --boundless-input-mode "guest-witness-v1"
            --boundless-deposit-program-url "${{ inputs.boundless_deposit_program_url }}"
            --boundless-withdraw-program-url "${{ inputs.boundless_withdraw_program_url }}"
            --boundless-input-s3-bucket "${{ inputs.boundless_input_s3_bucket }}"
            --boundless-deposit-owallet-ivk-hex "$DEPOSIT_OWALLET_IVK_HEX"
            --boundless-withdraw-owallet-ovk-hex "$WITHDRAW_OWALLET_OVK_HEX"
            --boundless-witness-juno-scan-url "$WITNESS_JUNO_SCAN_URL"
            --boundless-witness-juno-rpc-url "$WITNESS_JUNO_RPC_URL"
            --boundless-deposit-witness-wallet-id "$DEPOSIT_WALLET_ID"
            --boundless-deposit-witness-txid "$DEPOSIT_TXID"
            --boundless-deposit-witness-action-index "$DEPOSIT_ACTION_INDEX"
            --boundless-withdraw-witness-wallet-id "$WITHDRAW_WALLET_ID"
            --boundless-withdraw-witness-txid "$WITHDRAW_TXID"
            --boundless-withdraw-witness-action-index "$WITHDRAW_ACTION_INDEX"
            --boundless-withdraw-witness-withdrawal-id-hex "$WITHDRAW_WITHDRAWAL_ID_HEX"
            --boundless-withdraw-witness-recipient-raw-address-hex "$WITHDRAW_RECIPIENT_RAW_ADDRESS_HEX"
            --boundless-min-price-wei "${{ inputs.boundless_min_price_wei }}"
            --boundless-max-price-wei "${{ inputs.boundless_max_price_wei }}"
            --boundless-max-price-cap-wei "${{ inputs.boundless_max_price_cap_wei }}"
            --boundless-max-price-bump-multiplier "${{ inputs.boundless_max_price_bump_multiplier }}"
            --boundless-max-price-bump-retries "${{ inputs.boundless_max_price_bump_retries }}"
            --boundless-lock-stake-wei "${{ inputs.boundless_lock_stake_wei }}"
            --boundless-bidding-delay-seconds "${{ inputs.boundless_bidding_delay_seconds }}"
            --boundless-ramp-up-period-seconds "${{ inputs.boundless_ramp_up_period_seconds }}"
            --boundless-lock-timeout-seconds "${{ inputs.boundless_lock_timeout_seconds }}"
            --boundless-timeout-seconds "${{ inputs.boundless_timeout_seconds }}"
            --output "$E2E_WORKDIR/reports/testnet-e2e-summary.json"
            --force
          )
          ./deploy/operators/dkg/e2e/run-testnet-e2e.sh "${ARGS[@]}"

      - name: Upload E2E Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-testnet-deploy
          path: |
            ${{ runner.temp }}/testnet-e2e/reports
            ${{ runner.temp }}/testnet-e2e/dkg
