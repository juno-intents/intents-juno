name: release-operator-stack-ami

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region for operator AMI build"
        required: true
        default: "us-east-1"
        type: string
      aws_instance_type:
        description: "EC2 instance type for temporary AMI builder"
        required: true
        default: "c7i.4xlarge"
        type: string
      aws_name_prefix:
        description: "Name prefix for AMI and temporary build resources"
        required: true
        default: "intents-juno-operator-stack"
        type: string
      aws_vpc_id:
        description: "Optional VPC id for AMI builder instance"
        required: false
        default: ""
        type: string
      aws_subnet_id:
        description: "Optional subnet id for AMI builder instance"
        required: false
        default: ""
        type: string
      source_ami_id:
        description: "Optional source AMI id for incremental sync (defaults to latest released operator-stack-ami-latest AMI for region when available)"
        required: false
        default: ""
        type: string
      sync_timeout_seconds:
        description: "Max seconds to wait for junocashd sync"
        required: true
        default: "21600"
        type: string
      release_tag:
        description: "Release tag to create/update"
        required: true
        default: "operator-stack-ami-latest"
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      AWS_STATIC_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_STATIC_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC Role)
        if: ${{ env.AWS_STATIC_ACCESS_KEY_ID == '' && env.AWS_STATIC_SECRET_ACCESS_KEY == '' && env.AWS_ROLE_TO_ASSUME != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          role-duration-seconds: 21600
          aws-region: ${{ inputs.aws_region }}

      - name: Configure AWS Credentials (Static Secrets)
        if: ${{ env.AWS_STATIC_ACCESS_KEY_ID != '' && env.AWS_STATIC_SECRET_ACCESS_KEY != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}

      - name: Validate Required AWS Auth
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" || -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]]; then
            if [[ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" || -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]]; then
              echo "Both AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY must be set when using static AWS credentials"
              exit 1
            fi
          elif [[ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]]; then
            echo "Either AWS_ROLE_TO_ASSUME or static AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY secrets are required"
            exit 1
          fi

      - name: Resolve Builder Network
        id: resolve_network
        shell: bash
        run: |
          set -euo pipefail

          resolved_vpc_id="${{ inputs.aws_vpc_id }}"
          if [[ -z "$resolved_vpc_id" ]]; then
            resolved_vpc_id="$(aws ec2 describe-vpcs --filters Name=isDefault,Values=true Name=state,Values=available --query 'Vpcs[0].VpcId' --output text)"
            if [[ "$resolved_vpc_id" == "None" ]]; then
              resolved_vpc_id=""
            fi
          fi
          if [[ -z "$resolved_vpc_id" ]]; then
            resolved_vpc_id="$(aws ec2 describe-vpcs --filters Name=state,Values=available --query 'Vpcs[0].VpcId' --output text)"
            if [[ "$resolved_vpc_id" == "None" ]]; then
              resolved_vpc_id=""
            fi
          fi
          if [[ -z "$resolved_vpc_id" ]]; then
            echo "failed to resolve VPC id; set workflow input aws_vpc_id"
            exit 1
          fi

          resolved_subnet_id="${{ inputs.aws_subnet_id }}"
          if [[ -z "$resolved_subnet_id" ]]; then
            resolved_subnet_id="$(aws ec2 describe-subnets --filters Name=vpc-id,Values="$resolved_vpc_id" Name=state,Values=available Name=map-public-ip-on-launch,Values=true --query 'Subnets[0].SubnetId' --output text)"
            if [[ "$resolved_subnet_id" == "None" ]]; then
              resolved_subnet_id=""
            fi
          fi
          if [[ -z "$resolved_subnet_id" ]]; then
            resolved_subnet_id="$(aws ec2 describe-subnets --filters Name=vpc-id,Values="$resolved_vpc_id" Name=state,Values=available --query 'Subnets[0].SubnetId' --output text)"
            if [[ "$resolved_subnet_id" == "None" ]]; then
              resolved_subnet_id=""
            fi
          fi
          if [[ -z "$resolved_subnet_id" ]]; then
            echo "failed to resolve subnet id in VPC $resolved_vpc_id; set workflow input aws_subnet_id"
            exit 1
          fi

          echo "Resolved builder network: vpc_id=$resolved_vpc_id subnet_id=$resolved_subnet_id"
          echo "vpc_id=$resolved_vpc_id" >> "$GITHUB_OUTPUT"
          echo "subnet_id=$resolved_subnet_id" >> "$GITHUB_OUTPUT"

      - name: Resolve Source AMI
        id: resolve_source_ami
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          resolved_source_ami_id="${{ inputs.source_ami_id }}"
          if [[ -z "$resolved_source_ami_id" ]]; then
            tmpdir="$(mktemp -d)"
            if gh release download "operator-stack-ami-latest" \
              --repo "${{ github.repository }}" \
              --pattern "operator-ami-manifest.json" \
              --dir "$tmpdir" \
              --clobber >/dev/null 2>&1; then
              resolved_source_ami_id="$(jq -r --arg region "${{ inputs.aws_region }}" '.regions[$region].ami_id // empty' "$tmpdir/operator-ami-manifest.json")"
            fi
            rm -rf "$tmpdir"
          fi

          if [[ -n "$resolved_source_ami_id" ]]; then
            echo "Resolved source AMI: $resolved_source_ami_id"
            echo "source_ami_id=$resolved_source_ami_id" >> "$GITHUB_OUTPUT"
          else
            echo "No source AMI resolved; build will start from latest Ubuntu base image"
          fi

      - name: Build Operator Stack AMI
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci/out

          source_ami_args=()
          if [[ -n "${{ steps.resolve_source_ami.outputs.source_ami_id }}" ]]; then
            source_ami_args=(--source-ami-id "${{ steps.resolve_source_ami.outputs.source_ami_id }}")
          fi

          ./deploy/shared/runbooks/build-operator-stack-ami.sh create \
            --aws-region "${{ inputs.aws_region }}" \
            --instance-type "${{ inputs.aws_instance_type }}" \
            --name-prefix "${{ inputs.aws_name_prefix }}" \
            --vpc-id "${{ steps.resolve_network.outputs.vpc_id }}" \
            --subnet-id "${{ steps.resolve_network.outputs.subnet_id }}" \
            --repo-commit "${GITHUB_SHA}" \
            --sync-timeout-seconds "${{ inputs.sync_timeout_seconds }}" \
            "${source_ami_args[@]}" \
            --manifest-out ".ci/out/operator-ami-manifest.json" \
            --metadata-out ".ci/out/operator-stack-bootstrap.json" | tee ".ci/out/operator-ami-id.txt"

          sha256sum ".ci/out/operator-ami-manifest.json" > ".ci/out/operator-ami-manifest.json.sha256"
          sha256sum ".ci/out/operator-stack-bootstrap.json" > ".ci/out/operator-stack-bootstrap.json.sha256"

      - name: Create or Update Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ inputs.release_tag }}"

          region="${{ inputs.aws_region }}"
          ami_id="$(jq -r --arg region "$region" '.regions[$region].ami_id // empty' .ci/out/operator-ami-manifest.json)"
          if [[ -z "$ami_id" ]]; then
            echo "failed to resolve AMI id from operator-ami-manifest.json for region=$region"
            exit 1
          fi
          block_height="$(jq -r '.junocashd.synced_block_height' .ci/out/operator-ami-manifest.json)"
          block_hash="$(jq -r '.junocashd.synced_block_hash' .ci/out/operator-ami-manifest.json)"
          notes="Operator stack AMI release for ${region}

          AMI: ${ami_id}
          Synced blockstamp: height=${block_height} hash=${block_hash}
          Repo commit: ${GITHUB_SHA}"

          if gh release view "$tag" >/dev/null 2>&1; then
            gh release upload "$tag" \
              ".ci/out/operator-ami-manifest.json" \
              ".ci/out/operator-ami-manifest.json.sha256" \
              ".ci/out/operator-stack-bootstrap.json" \
              ".ci/out/operator-stack-bootstrap.json.sha256" \
              --clobber
            gh release edit "$tag" --title "$tag" --notes "$notes"
          else
            gh release create "$tag" \
              ".ci/out/operator-ami-manifest.json" \
              ".ci/out/operator-ami-manifest.json.sha256" \
              ".ci/out/operator-stack-bootstrap.json" \
              ".ci/out/operator-stack-bootstrap.json.sha256" \
              --title "$tag" \
              --notes "$notes"
          fi

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: operator-stack-ami-release
          path: |
            .ci/out/operator-ami-id.txt
            .ci/out/operator-ami-manifest.json
            .ci/out/operator-ami-manifest.json.sha256
            .ci/out/operator-stack-bootstrap.json
            .ci/out/operator-stack-bootstrap.json.sha256
