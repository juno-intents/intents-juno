name: release-bridge-guest-programs

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to create/update"
        required: true
        default: "bridge-guests-latest"
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install SP1 Toolchain
        shell: bash
        run: |
          set -euo pipefail

          rustup toolchain install 1.91.1 --profile minimal
          rustup default 1.91.1
          rustc --version

          curl -L https://sp1up.succinct.xyz | bash
          echo "$HOME/.sp1/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.sp1/bin:$PATH"
          sp1up
          cargo prove install-toolchain

          command -v cargo >/dev/null 2>&1
          cargo prove --version

      - name: Build Guests And Generate Profiles
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci/out

          pushd zk >/dev/null
          cargo prove build -p deposit-guest -p withdraw-guest --output-directory ../.ci/out | tee ../.ci/out/build.log
          popd >/dev/null

          deposit_elf=".ci/out/deposit-guest"
          withdraw_elf=".ci/out/withdraw-guest"
          [[ -f "$deposit_elf" ]] || { echo "missing deposit guest output: $deposit_elf"; exit 1; }
          [[ -f "$withdraw_elf" ]] || { echo "missing withdraw guest output: $withdraw_elf"; exit 1; }

          pushd zk >/dev/null
          deposit_vkey="$(cargo prove vkey --elf ../${deposit_elf} | grep -Eo '0x[0-9a-fA-F]{64}' | tail -n 1 | tr '[:upper:]' '[:lower:]')"
          withdraw_vkey="$(cargo prove vkey --elf ../${withdraw_elf} | grep -Eo '0x[0-9a-fA-F]{64}' | tail -n 1 | tr '[:upper:]' '[:lower:]')"
          popd >/dev/null
          [[ -n "$deposit_vkey" ]] || { echo "failed to parse deposit vkey"; exit 1; }
          [[ -n "$withdraw_vkey" ]] || { echo "failed to parse withdraw vkey"; exit 1; }

          tag="${{ inputs.release_tag }}"
          repo="${GITHUB_REPOSITORY}"
          deposit_asset="deposit-guest-${deposit_vkey#0x}.elf"
          withdraw_asset="withdraw-guest-${withdraw_vkey#0x}.elf"
          deposit_program_url="https://github.com/${repo}/releases/download/${tag}/${deposit_asset}"
          withdraw_program_url="https://github.com/${repo}/releases/download/${tag}/${withdraw_asset}"

          cp "$deposit_elf" ".ci/out/${deposit_asset}"
          cp "$withdraw_elf" ".ci/out/${withdraw_asset}"
          sha256sum ".ci/out/${deposit_asset}" > ".ci/out/${deposit_asset}.sha256"
          sha256sum ".ci/out/${withdraw_asset}" > ".ci/out/${withdraw_asset}.sha256"

          jq -n \
            --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg tag "$tag" \
            --arg repo "$repo" \
            --arg commit "$GITHUB_SHA" \
            --arg deposit_vkey "$deposit_vkey" \
            --arg withdraw_vkey "$withdraw_vkey" \
            --arg deposit_asset "$deposit_asset" \
            --arg withdraw_asset "$withdraw_asset" \
            --arg deposit_program_url "$deposit_program_url" \
            --arg withdraw_program_url "$withdraw_program_url" \
            '{
              generated_at: $generated_at,
              release_tag: $tag,
              repository: $repo,
              commit: $commit,
              bridge_deposit_image_id: $deposit_vkey,
              bridge_withdraw_image_id: $withdraw_vkey,
              bridge_deposit_program_vkey: $deposit_vkey,
              bridge_withdraw_program_vkey: $withdraw_vkey,
              boundless_deposit_program_url: $deposit_program_url,
              boundless_withdraw_program_url: $withdraw_program_url,
              sp1_deposit_program_url: $deposit_program_url,
              sp1_withdraw_program_url: $withdraw_program_url,
              assets: {
                deposit_guest_elf: $deposit_asset,
                withdraw_guest_elf: $withdraw_asset
              }
            }' > .ci/out/bridge-guest-profiles.json
          sha256sum .ci/out/bridge-guest-profiles.json > .ci/out/bridge-guest-profiles.json.sha256

          {
            echo "BRIDGE_DEPOSIT_IMAGE_ID=${deposit_vkey}"
            echo "BRIDGE_WITHDRAW_IMAGE_ID=${withdraw_vkey}"
            echo "BRIDGE_DEPOSIT_PROGRAM_VKEY=${deposit_vkey}"
            echo "BRIDGE_WITHDRAW_PROGRAM_VKEY=${withdraw_vkey}"
            echo "BOUNDLESS_DEPOSIT_PROGRAM_URL=${deposit_program_url}"
            echo "BOUNDLESS_WITHDRAW_PROGRAM_URL=${withdraw_program_url}"
            echo "SP1_DEPOSIT_PROGRAM_URL=${deposit_program_url}"
            echo "SP1_WITHDRAW_PROGRAM_URL=${withdraw_program_url}"
          } > .ci/out/bridge-guest-release.env
          sha256sum .ci/out/bridge-guest-release.env > .ci/out/bridge-guest-release.env.sha256

      - name: Create Or Update Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ inputs.release_tag }}"

          notes="$(cat <<EOF
          Bridge guest release for ${GITHUB_SHA}

          Includes:
          - Deposit guest ELF + checksum
          - Withdraw guest ELF + checksum
          - Release profile JSON + env file (SP1 program vkeys + program URLs)
          EOF
          )"

          assets=(
            .ci/out/deposit-guest-*.elf
            .ci/out/deposit-guest-*.elf.sha256
            .ci/out/withdraw-guest-*.elf
            .ci/out/withdraw-guest-*.elf.sha256
            .ci/out/bridge-guest-profiles.json
            .ci/out/bridge-guest-profiles.json.sha256
            .ci/out/bridge-guest-release.env
            .ci/out/bridge-guest-release.env.sha256
          )

          if gh release view "$tag" >/dev/null 2>&1; then
            gh release upload "$tag" "${assets[@]}" --clobber
            gh release edit "$tag" --title "$tag" --notes "$notes"
          else
            gh release create "$tag" "${assets[@]}" --title "$tag" --notes "$notes"
          fi

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bridge-guest-release
          path: |
            .ci/out/build.log
            .ci/out/deposit-guest-*.elf
            .ci/out/deposit-guest-*.elf.sha256
            .ci/out/withdraw-guest-*.elf
            .ci/out/withdraw-guest-*.elf.sha256
            .ci/out/bridge-guest-profiles.json
            .ci/out/bridge-guest-profiles.json.sha256
            .ci/out/bridge-guest-release.env
            .ci/out/bridge-guest-release.env.sha256
