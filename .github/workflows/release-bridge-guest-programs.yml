name: release-bridge-guest-programs

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to create/update"
        required: true
        default: "bridge-guests-latest"
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install RISC0 Toolchain
        shell: bash
        run: |
          set -euo pipefail

          rustup toolchain install 1.91.1 --profile minimal
          rustup default 1.91.1
          rustc --version

          cargo install --locked cargo-risczero --version 3.0.5 --force

          if ! command -v rzup >/dev/null 2>&1; then
            curl -sSfL https://risczero.com/install | bash
          fi
          export PATH="$HOME/.risc0/bin:$PATH"
          rzup install

          command -v r0vm >/dev/null 2>&1
          command -v rzup >/dev/null 2>&1
          cargo risczero --version
          r0vm --version

      - name: Build Guests And Generate Profiles
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci/out

          cargo risczero build --manifest-path zk/deposit_guest/guest/Cargo.toml | tee .ci/out/deposit-build.log
          cargo risczero build --manifest-path zk/withdraw_guest/guest/Cargo.toml | tee .ci/out/withdraw-build.log

          deposit_image_id="$(grep -Eo 'ImageID: [0-9a-f]{64}' .ci/out/deposit-build.log | awk '{print $2}' | tail -n 1)"
          withdraw_image_id="$(grep -Eo 'ImageID: [0-9a-f]{64}' .ci/out/withdraw-build.log | awk '{print $2}' | tail -n 1)"
          [[ -n "$deposit_image_id" ]] || { echo "failed to parse deposit image id"; exit 1; }
          [[ -n "$withdraw_image_id" ]] || { echo "failed to parse withdraw image id"; exit 1; }

          deposit_elf="zk/target/riscv32im-risc0-zkvm-elf/docker/deposit-guest.bin"
          withdraw_elf="zk/target/riscv32im-risc0-zkvm-elf/docker/withdraw-guest.bin"
          [[ -f "$deposit_elf" ]] || { echo "missing deposit guest output: $deposit_elf"; exit 1; }
          [[ -f "$withdraw_elf" ]] || { echo "missing withdraw guest output: $withdraw_elf"; exit 1; }

          deposit_image_id_verify="$(r0vm --id --elf "$deposit_elf" | tr -d '\r\n' | tr '[:upper:]' '[:lower:]')"
          withdraw_image_id_verify="$(r0vm --id --elf "$withdraw_elf" | tr -d '\r\n' | tr '[:upper:]' '[:lower:]')"
          [[ "$deposit_image_id" == "$deposit_image_id_verify" ]] || { echo "deposit image id mismatch: $deposit_image_id != $deposit_image_id_verify"; exit 1; }
          [[ "$withdraw_image_id" == "$withdraw_image_id_verify" ]] || { echo "withdraw image id mismatch: $withdraw_image_id != $withdraw_image_id_verify"; exit 1; }

          tag="${{ inputs.release_tag }}"
          repo="${GITHUB_REPOSITORY}"
          deposit_asset="deposit-guest-${deposit_image_id}.elf"
          withdraw_asset="withdraw-guest-${withdraw_image_id}.elf"
          deposit_program_url="https://github.com/${repo}/releases/download/${tag}/${deposit_asset}"
          withdraw_program_url="https://github.com/${repo}/releases/download/${tag}/${withdraw_asset}"

          cp "$deposit_elf" ".ci/out/${deposit_asset}"
          cp "$withdraw_elf" ".ci/out/${withdraw_asset}"
          sha256sum ".ci/out/${deposit_asset}" > ".ci/out/${deposit_asset}.sha256"
          sha256sum ".ci/out/${withdraw_asset}" > ".ci/out/${withdraw_asset}.sha256"

          jq -n \
            --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg tag "$tag" \
            --arg repo "$repo" \
            --arg commit "$GITHUB_SHA" \
            --arg deposit_image_id "0x${deposit_image_id}" \
            --arg withdraw_image_id "0x${withdraw_image_id}" \
            --arg deposit_asset "$deposit_asset" \
            --arg withdraw_asset "$withdraw_asset" \
            --arg deposit_program_url "$deposit_program_url" \
            --arg withdraw_program_url "$withdraw_program_url" \
            '{
              generated_at: $generated_at,
              release_tag: $tag,
              repository: $repo,
              commit: $commit,
              bridge_deposit_image_id: $deposit_image_id,
              bridge_withdraw_image_id: $withdraw_image_id,
              boundless_deposit_program_url: $deposit_program_url,
              boundless_withdraw_program_url: $withdraw_program_url,
              assets: {
                deposit_guest_elf: $deposit_asset,
                withdraw_guest_elf: $withdraw_asset
              }
            }' > .ci/out/bridge-guest-profiles.json
          sha256sum .ci/out/bridge-guest-profiles.json > .ci/out/bridge-guest-profiles.json.sha256

          {
            echo "BRIDGE_DEPOSIT_IMAGE_ID=0x${deposit_image_id}"
            echo "BRIDGE_WITHDRAW_IMAGE_ID=0x${withdraw_image_id}"
            echo "BOUNDLESS_DEPOSIT_PROGRAM_URL=${deposit_program_url}"
            echo "BOUNDLESS_WITHDRAW_PROGRAM_URL=${withdraw_program_url}"
          } > .ci/out/bridge-guest-release.env
          sha256sum .ci/out/bridge-guest-release.env > .ci/out/bridge-guest-release.env.sha256

      - name: Create Or Update Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ inputs.release_tag }}"

          notes="$(cat <<EOF
          Bridge guest release for ${GITHUB_SHA}

          Includes:
          - Deposit guest ELF + checksum
          - Withdraw guest ELF + checksum
          - Release profile JSON + env file (image IDs + Boundless program URLs)
          EOF
          )"

          assets=(
            .ci/out/deposit-guest-*.elf
            .ci/out/deposit-guest-*.elf.sha256
            .ci/out/withdraw-guest-*.elf
            .ci/out/withdraw-guest-*.elf.sha256
            .ci/out/bridge-guest-profiles.json
            .ci/out/bridge-guest-profiles.json.sha256
            .ci/out/bridge-guest-release.env
            .ci/out/bridge-guest-release.env.sha256
          )

          if gh release view "$tag" >/dev/null 2>&1; then
            gh release upload "$tag" "${assets[@]}" --clobber
            gh release edit "$tag" --title "$tag" --notes "$notes"
          else
            gh release create "$tag" "${assets[@]}" --title "$tag" --notes "$notes"
          fi

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bridge-guest-release
          path: |
            .ci/out/deposit-build.log
            .ci/out/withdraw-build.log
            .ci/out/deposit-guest-*.elf
            .ci/out/deposit-guest-*.elf.sha256
            .ci/out/withdraw-guest-*.elf
            .ci/out/withdraw-guest-*.elf.sha256
            .ci/out/bridge-guest-profiles.json
            .ci/out/bridge-guest-profiles.json.sha256
            .ci/out/bridge-guest-release.env
            .ci/out/bridge-guest-release.env.sha256
