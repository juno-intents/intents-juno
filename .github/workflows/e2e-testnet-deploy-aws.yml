name: e2e-testnet-deploy-aws

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region for live e2e runner"
        required: true
        default: "us-east-1"
        type: string
      aws_instance_type:
        description: "EC2 instance type for live e2e runner"
        required: true
        default: "c7i.4xlarge"
        type: string
      operator_instance_count:
        description: "Number of dedicated operator hosts"
        required: true
        default: "5"
        type: string
      operator_instance_type:
        description: "EC2 instance type for each operator host"
        required: true
        default: "c7i.large"
        type: string
      ssh_allowed_cidr:
        description: "Optional SSH CIDR allowlist (auto-detected caller /32 if empty)"
        required: false
        default: ""
        type: string
      base_rpc_url:
        description: "Base testnet RPC URL"
        required: true
        type: string
      base_chain_id:
        description: "Base testnet chain ID"
        required: true
        default: "84532"
        type: string
      base_operator_fund_wei:
        description: "Prefund amount per operator in wei"
        required: true
        default: "1000000000000000"
        type: string
      bridge_verifier_address:
        description: "Verifier router address"
        required: true
        type: string
      bridge_deposit_image_id:
        description: "Deposit image ID (bytes32 hex)"
        required: true
        type: string
      bridge_withdraw_image_id:
        description: "Withdraw image ID (bytes32 hex)"
        required: true
        type: string
      bridge_run_timeout:
        description: "bridge-e2e timeout duration (e.g. 90m)"
        required: true
        default: "90m"
        type: string
      boundless_rpc_url:
        description: "Boundless submission RPC URL"
        required: true
        default: "https://mainnet.base.org"
        type: string
      boundless_input_mode:
        description: "Boundless input mode (private-input|guest-witness-v1)"
        required: true
        default: "guest-witness-v1"
        type: string
      boundless_deposit_program_url:
        description: "Deposit guest program URL for Boundless"
        required: true
        type: string
      boundless_withdraw_program_url:
        description: "Withdraw guest program URL for Boundless"
        required: true
        type: string
      boundless_min_price_wei:
        description: "Boundless min price in wei"
        required: true
        default: "0"
        type: string
      boundless_max_price_wei:
        description: "Boundless max price in wei"
        required: true
        default: "50000000000000"
        type: string
      boundless_lock_stake_wei:
        description: "Boundless lock stake in wei"
        required: true
        default: "5000000000000000000"
        type: string
      boundless_bidding_delay_seconds:
        description: "Boundless bidding delay in seconds"
        required: true
        default: "85"
        type: string
      boundless_ramp_up_period_seconds:
        description: "Boundless ramp-up period in seconds"
        required: true
        default: "170"
        type: string
      boundless_lock_timeout_seconds:
        description: "Boundless lock timeout in seconds"
        required: true
        default: "625"
        type: string
      boundless_timeout_seconds:
        description: "Boundless timeout in seconds"
        required: true
        default: "1500"
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  run-e2e:
    runs-on: ubuntu-latest
    env:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials (OIDC Role)
        if: ${{ env.AWS_ROLE_TO_ASSUME != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_region }}

      - name: Configure AWS Credentials (Static Secrets)
        if: ${{ env.AWS_ROLE_TO_ASSUME == '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}

      - name: Validate Required Secrets
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]]; then
            if [[ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]]; then
              echo "AWS_ACCESS_KEY_ID secret is required when AWS_ROLE_TO_ASSUME is not set"
              exit 1
            fi
            if [[ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]]; then
              echo "AWS_SECRET_ACCESS_KEY secret is required when AWS_ROLE_TO_ASSUME is not set"
              exit 1
            fi
          fi
          if [[ -z "${{ secrets.BASE_FUNDER_PRIVATE_KEY_HEX }}" ]]; then
            echo "BASE_FUNDER_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}" ]]; then
            echo "JUNO_FUNDER_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi
          if [[ -z "${{ secrets.BOUNDLESS_REQUESTOR_PRIVATE_KEY_HEX }}" ]]; then
            echo "BOUNDLESS_REQUESTOR_PRIVATE_KEY_HEX secret is required"
            exit 1
          fi

      - name: Prepare Secret Files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci/secrets
          printf '%s\n' "${{ secrets.BASE_FUNDER_PRIVATE_KEY_HEX }}" > .ci/secrets/base-funder.key
          printf '%s\n' "${{ secrets.JUNO_FUNDER_PRIVATE_KEY_HEX }}" > .ci/secrets/juno-funder.key
          chmod 0600 .ci/secrets/base-funder.key .ci/secrets/juno-funder.key

          printf '%s\n' "${{ secrets.BOUNDLESS_REQUESTOR_PRIVATE_KEY_HEX }}" > .ci/secrets/boundless-requestor.key
          chmod 0600 .ci/secrets/boundless-requestor.key

      - name: Run AWS Live E2E
        shell: bash
        run: |
          set -euo pipefail
          WORKDIR="${RUNNER_TEMP}/aws-live-e2e"

          ARGS=(
            run
            --workdir "$WORKDIR"
            --aws-region "${{ inputs.aws_region }}"
            --aws-instance-type "${{ inputs.aws_instance_type }}"
            --operator-instance-count "${{ inputs.operator_instance_count }}"
            --operator-instance-type "${{ inputs.operator_instance_type }}"
            --aws-root-volume-gb "200"
            --base-funder-key-file ".ci/secrets/base-funder.key"
            --juno-funder-key-file ".ci/secrets/juno-funder.key"
          )

          if [[ -n "${{ inputs.ssh_allowed_cidr }}" ]]; then
            ARGS+=(--ssh-allowed-cidr "${{ inputs.ssh_allowed_cidr }}")
          fi
          ARGS+=(--boundless-requestor-key-file ".ci/secrets/boundless-requestor.key")

          E2E_ARGS=(
            --base-rpc-url "${{ inputs.base_rpc_url }}"
            --base-chain-id "${{ inputs.base_chain_id }}"
            --base-operator-fund-wei "${{ inputs.base_operator_fund_wei }}"
            --bridge-run-timeout "${{ inputs.bridge_run_timeout }}"
            --bridge-verifier-address "${{ inputs.bridge_verifier_address }}"
            --bridge-deposit-image-id "${{ inputs.bridge_deposit_image_id }}"
            --bridge-withdraw-image-id "${{ inputs.bridge_withdraw_image_id }}"
            --boundless-rpc-url "${{ inputs.boundless_rpc_url }}"
            --boundless-input-mode "${{ inputs.boundless_input_mode }}"
            --boundless-deposit-program-url "${{ inputs.boundless_deposit_program_url }}"
            --boundless-withdraw-program-url "${{ inputs.boundless_withdraw_program_url }}"
            --boundless-min-price-wei "${{ inputs.boundless_min_price_wei }}"
            --boundless-max-price-wei "${{ inputs.boundless_max_price_wei }}"
            --boundless-lock-stake-wei "${{ inputs.boundless_lock_stake_wei }}"
            --boundless-bidding-delay-seconds "${{ inputs.boundless_bidding_delay_seconds }}"
            --boundless-ramp-up-period-seconds "${{ inputs.boundless_ramp_up_period_seconds }}"
            --boundless-lock-timeout-seconds "${{ inputs.boundless_lock_timeout_seconds }}"
            --boundless-timeout-seconds "${{ inputs.boundless_timeout_seconds }}"
          )

          ARGS+=(-- "${E2E_ARGS[@]}")

          ./deploy/operators/dkg/e2e/run-testnet-e2e-aws.sh "${ARGS[@]}"

      - name: Fallback AWS Destroy
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          ./deploy/operators/dkg/e2e/run-testnet-e2e-aws.sh cleanup \
            --workdir "${RUNNER_TEMP}/aws-live-e2e" \
            --aws-region "${{ inputs.aws_region }}"

      - name: Upload E2E Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-testnet-deploy-aws
          path: |
            ${{ runner.temp }}/aws-live-e2e/artifacts
            ${{ runner.temp }}/aws-live-e2e/infra
